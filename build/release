#!/usr/bin/env bash

cd "$(dirname "${BASH_SOURCE[0]}")/../lib"
source ../modern.sh

outfile="../modern.sh"

say "building new monolithic library..."
setup() { echo > ,; esc="$(printf '\033')"; }
teardown() { rm ,; }
compile() {
  cat \
  init.bash , \
  \
  data.bash , \
  display.bash , \
  exit.bash , \
  paths.bash , \
  script.bash , \
  time.bash , \
  utility.bash , \
  wrappers.bash , \
  \
  compatibility.bash , \
  finalize.bash;
}
nl_squeeze() { awk 'BEGIN{RS="";ORS="\n\n"}1' ;}
comments() { \grep ${1:-} '^\s*#'; }
no_comments() { comments -v; }

setup

compile | no_comments | nl_squeeze > "$outfile"
say "Adding Shebang..."
awk 'BEGIN{print "#!/usr/bin/env bash"} {print}' "$outfile" > tmpfile && mv tmpfile "$outfile"
run "Set Executable" chmod +x "$outfile"

say "building documentation..."
usages() { \grep '^\s*# usage:' -A 4; }
mutate() {
  sed "s/# usage:/\n$esc""[35musage:$esc""[0m/g" | \
  sed "s/# example:/$esc""[34mexample:$esc""[0m/g" | \
  sed "s/#\s*/$esc""[34m\t$esc""[0m/g"
}

compile | usages | comments | nl_squeeze | mutate > ../doc/help.ansi

teardown
ok
